{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/FTS/WORK/NEXT-BFF/mmis-fe-fts/src/services/auth.service.ts"],"sourcesContent":["// src/services/auth.service.ts\r\nimport 'server-only';\r\nimport { cookies } from 'next/headers';\r\nimport { experimental_taintUniqueValue } from 'react';\r\n\r\n/**\r\n * Data Access Layer (DAL): Fetches the current session from the Backend API.\r\n * Uses 'server-only' to ensure this logic never executes on the client.\r\n */\r\nexport async function getSession() {\r\n  try {\r\n    // 1. Await the asynchronous cookie store (Next.js 16 requirement)\r\n    const cookieStore = await cookies();\r\n    const token = cookieStore.get('auth_token')?.value;\r\n\r\n    if (!token) return null;\r\n\r\n    /**\r\n     * Security Tainting: \r\n     * Prevents the raw JWT from being accidentally passed to a Client Component props.\r\n     */\r\n experimental_taintUniqueValue(\r\n  'Do not pass raw session tokens to the client.',\r\n  // token,\r\n  { token },\r\n  token\r\n);\r\n\r\n\r\n    // 2. Internal fetch to the Express Backend (BFF)\r\n    const res = await fetch(`${process.env.BACKEND_API_URL}/api/auth/me`, {\r\n      method: 'GET',\r\n      headers: { \r\n        Authorization: `Bearer ${token}`,\r\n        'Content-Type': 'application/json'\r\n      },\r\n      // Using next: { revalidate: 0 } ensures we get fresh data every time\r\n      next: { revalidate: 0 } \r\n    });\r\n\r\n    if (!res.ok) {\r\n      // If the backend says the token is invalid, the session is null\r\n      return null;\r\n    }\r\n\r\n    const sessionData = await res.json();\r\n\r\n    // 3. Return the user object (e.g., id, email, role, kycStatus, adminStatus)\r\n    return sessionData;\r\n\r\n  } catch (error) {\r\n    console.error(\"Auth Service: Error fetching session\", error);\r\n    return null;\r\n  }\r\n}"],"names":[],"mappings":"AAAA,+BAA+B;;;;;AAC/B;AACA;AACA;;;;AAMO,eAAe;IACpB,IAAI;QACF,kEAAkE;QAClE,MAAM,cAAc,MAAM,IAAA,yPAAO;QACjC,MAAM,QAAQ,YAAY,GAAG,CAAC,eAAe;QAE7C,IAAI,CAAC,OAAO,OAAO;QAEnB;;;KAGC,GACJ,IAAA,qVAA6B,EAC5B,iDACA,SAAS;QACT;YAAE;QAAM,GACR;QAIE,iDAAiD;QACjD,MAAM,MAAM,MAAM,MAAM,GAAG,QAAQ,GAAG,CAAC,eAAe,CAAC,YAAY,CAAC,EAAE;YACpE,QAAQ;YACR,SAAS;gBACP,eAAe,CAAC,OAAO,EAAE,OAAO;gBAChC,gBAAgB;YAClB;YACA,qEAAqE;YACrE,MAAM;gBAAE,YAAY;YAAE;QACxB;QAEA,IAAI,CAAC,IAAI,EAAE,EAAE;YACX,gEAAgE;YAChE,OAAO;QACT;QAEA,MAAM,cAAc,MAAM,IAAI,IAAI;QAElC,4EAA4E;QAC5E,OAAO;IAET,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,wCAAwC;QACtD,OAAO;IACT;AACF"}},
    {"offset": {"line": 98, "column": 0}, "map": {"version":3,"sources":["file:///C:/FTS/WORK/NEXT-BFF/mmis-fe-fts/src/proxy.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { getSession } from '@/services/auth.service';\r\n\r\n/**\r\n * Audit Log Utility: Records sensitive routing events to the Backend.\r\n */\r\nasync function logAction(userId: string, action: string, metadata: object, ip: string) {\r\n  try {\r\n    await fetch(`${process.env.BACKEND_API_URL}/api/audit-logs`, {\r\n      method: 'POST',\r\n      headers: { \r\n        'Content-Type': 'application/json',\r\n        'x-internal-secret': process.env.INTERNAL_AUTH_KEY || '' \r\n      },\r\n      body: JSON.stringify({ userId, action, timestamp: new Date().toISOString(), ipAddress: ip, details: metadata }),\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Audit Logging Failed:\", error);\r\n  }\r\n}\r\n\r\nexport default async function proxy(req: NextRequest) {\r\n  const { pathname } = req.nextUrl;\r\n  const ip = req.headers.get('x-forwarded-for') || '0.0.0.0';\r\n\r\n  // 1. Skip Public Assets and Authentication Routes\r\n  const publicRoutes = ['/login', '/signup', '/', '/verify-email'];\r\n  if (publicRoutes.includes(pathname) || pathname.startsWith('/_next')) {\r\n    return NextResponse.next();\r\n  }\r\n\r\n  // 2. Session Integrity Check\r\n  const session = await getSession();\r\n  if (!session) {\r\n    const loginUrl = new URL('/login', req.url);\r\n    loginUrl.searchParams.set('from', pathname);\r\n    return NextResponse.redirect(loginUrl);\r\n  }\r\n\r\n  // 3. Super Admin Fast-Path\r\n  if (session.role === 'SUPER_ADMIN') {\r\n    if (!pathname.startsWith('/super-admin')) {\r\n      return NextResponse.redirect(new URL('/super-admin', req.url));\r\n    }\r\n    return NextResponse.next();\r\n  }\r\n\r\n  // 4. Status Evaluation\r\n  const isApprovedVendor = session.role === 'VENDOR' && session.kycStatus === 'VERIFIED';\r\n  const isApprovedAdmin = session.role === 'MARKET_ADMIN' && session.adminStatus === 'APPROVED';\r\n  \r\n  // A user is considered \"In Onboarding\" if they aren't fully verified yet\r\n  const needsOnboarding = !isApprovedVendor && !isApprovedAdmin;\r\n\r\n  // 5. Routing Guardrails\r\n\r\n  // A. Force Onboarding: Non-verified users must go to /apply-access\r\n  if (needsOnboarding && pathname !== '/apply-access') {\r\n    return NextResponse.redirect(new URL('/apply-access', req.url));\r\n  }\r\n\r\n  // B. Prevent Looping: Approved users shouldn't see onboarding page\r\n  if (!needsOnboarding && pathname === '/apply-access') {\r\n    return NextResponse.redirect(new URL('/dashboard', req.url));\r\n  }\r\n\r\n  // C. Portal Protection: Explicitly block cross-role access to /dashboard\r\n  // (Assuming /dashboard is the shared entry point for approved Market/Vendor roles)\r\n  if (pathname === '/dashboard' && needsOnboarding) {\r\n    return NextResponse.redirect(new URL('/apply-access', req.url));\r\n  }\r\n\r\n  // D. Admin-Specific Portal Protection (if you have sub-routes like /market-admin/settings)\r\n  if (pathname.startsWith('/market-admin') && !isApprovedAdmin) {\r\n    await logAction(session.id, \"UNAUTHORIZED_ADMIN_ACCESS_ATTEMPT\", { pathname }, ip);\r\n    return NextResponse.redirect(new URL('/apply-access', req.url));\r\n  }\r\n\r\n  return NextResponse.next();\r\n}\r\n\r\nexport const config = {\r\n  matcher: ['/((?!api|_next/static|_next/image|favicon.ico).*)'],\r\n};"],"names":[],"mappings":";;;;;;AAAA;AACA;;;AAEA;;CAEC,GACD,eAAe,UAAU,MAAc,EAAE,MAAc,EAAE,QAAgB,EAAE,EAAU;IACnF,IAAI;QACF,MAAM,MAAM,GAAG,QAAQ,GAAG,CAAC,eAAe,CAAC,eAAe,CAAC,EAAE;YAC3D,QAAQ;YACR,SAAS;gBACP,gBAAgB;gBAChB,qBAAqB,QAAQ,GAAG,CAAC,iBAAiB,IAAI;YACxD;YACA,MAAM,KAAK,SAAS,CAAC;gBAAE;gBAAQ;gBAAQ,WAAW,IAAI,OAAO,WAAW;gBAAI,WAAW;gBAAI,SAAS;YAAS;QAC/G;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,yBAAyB;IACzC;AACF;AAEe,eAAe,MAAM,GAAgB;IAClD,MAAM,EAAE,QAAQ,EAAE,GAAG,IAAI,OAAO;IAChC,MAAM,KAAK,IAAI,OAAO,CAAC,GAAG,CAAC,sBAAsB;IAEjD,kDAAkD;IAClD,MAAM,eAAe;QAAC;QAAU;QAAW;QAAK;KAAgB;IAChE,IAAI,aAAa,QAAQ,CAAC,aAAa,SAAS,UAAU,CAAC,WAAW;QACpE,OAAO,6PAAY,CAAC,IAAI;IAC1B;IAEA,6BAA6B;IAC7B,MAAM,UAAU,MAAM,IAAA,gJAAU;IAChC,IAAI,CAAC,SAAS;QACZ,MAAM,WAAW,IAAI,IAAI,UAAU,IAAI,GAAG;QAC1C,SAAS,YAAY,CAAC,GAAG,CAAC,QAAQ;QAClC,OAAO,6PAAY,CAAC,QAAQ,CAAC;IAC/B;IAEA,2BAA2B;IAC3B,IAAI,QAAQ,IAAI,KAAK,eAAe;QAClC,IAAI,CAAC,SAAS,UAAU,CAAC,iBAAiB;YACxC,OAAO,6PAAY,CAAC,QAAQ,CAAC,IAAI,IAAI,gBAAgB,IAAI,GAAG;QAC9D;QACA,OAAO,6PAAY,CAAC,IAAI;IAC1B;IAEA,uBAAuB;IACvB,MAAM,mBAAmB,QAAQ,IAAI,KAAK,YAAY,QAAQ,SAAS,KAAK;IAC5E,MAAM,kBAAkB,QAAQ,IAAI,KAAK,kBAAkB,QAAQ,WAAW,KAAK;IAEnF,yEAAyE;IACzE,MAAM,kBAAkB,CAAC,oBAAoB,CAAC;IAE9C,wBAAwB;IAExB,mEAAmE;IACnE,IAAI,mBAAmB,aAAa,iBAAiB;QACnD,OAAO,6PAAY,CAAC,QAAQ,CAAC,IAAI,IAAI,iBAAiB,IAAI,GAAG;IAC/D;IAEA,mEAAmE;IACnE,IAAI,CAAC,mBAAmB,aAAa,iBAAiB;QACpD,OAAO,6PAAY,CAAC,QAAQ,CAAC,IAAI,IAAI,cAAc,IAAI,GAAG;IAC5D;IAEA,yEAAyE;IACzE,mFAAmF;IACnF,IAAI,aAAa,gBAAgB,iBAAiB;QAChD,OAAO,6PAAY,CAAC,QAAQ,CAAC,IAAI,IAAI,iBAAiB,IAAI,GAAG;IAC/D;IAEA,2FAA2F;IAC3F,IAAI,SAAS,UAAU,CAAC,oBAAoB,CAAC,iBAAiB;QAC5D,MAAM,UAAU,QAAQ,EAAE,EAAE,qCAAqC;YAAE;QAAS,GAAG;QAC/E,OAAO,6PAAY,CAAC,QAAQ,CAAC,IAAI,IAAI,iBAAiB,IAAI,GAAG;IAC/D;IAEA,OAAO,6PAAY,CAAC,IAAI;AAC1B;AAEO,MAAM,SAAS;IACpB,SAAS;QAAC;KAAoD;AAChE"}}]
}