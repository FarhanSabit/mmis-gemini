{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/FTS/WORK/NEXT-BFF/mmis-fe-fts/src/proxy.ts"],"sourcesContent":["// The proxy.ts Interceptor (Next.js 16) replaces the legacy middleware.ts & runs on the Node.js runtime: src/proxy.ts\r\n\r\nimport { NextRequest, NextResponse } from 'next/server';\r\nimport { getSession } from '@/services/auth.service';\r\n\r\n/**\r\n * Centralized Audit Log Utility\r\n * Logs sensitive routing events or administrative overrides to the Backend.\r\n */\r\nasync function logAction(userId: string, action: string, metadata: object, ip: string) {\r\n  try {\r\n    await fetch(`${process.env.BACKEND_API_URL}/api/audit-logs`, {\r\n      method: 'POST',\r\n      headers: { \r\n        'Content-Type': 'application/json',\r\n        'x-internal-secret': process.env.INTERNAL_AUTH_KEY || '' \r\n      },\r\n      body: JSON.stringify({\r\n        userId,\r\n        action,\r\n        timestamp: new Date().toISOString(),\r\n        ipAddress: ip,\r\n        details: metadata,\r\n      }),\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Audit Logging Failed:\", error);\r\n  }\r\n}\r\n\r\nexport default async function proxy(req: NextRequest) {\r\n  const { pathname } = req.nextUrl;\r\n  const ip = req.headers.get('x-forwarded-for') || '0.0.0.0';\r\n\r\n  // 1. Public Routes Bypass\r\n  // These routes do not require a session\r\n  const publicRoutes = ['/login', '/signup', '/', '/verify-email'];\r\n  if (publicRoutes.some(route => pathname === route) || pathname.startsWith('/_next')) {\r\n    return NextResponse.next();\r\n  }\r\n\r\n  // 2. Session Validation\r\n  const session = await getSession(req);\r\n\r\n  // Redirect to login if no session/token exists\r\n  if (!session) {\r\n    const loginUrl = new URL('/login', req.url);\r\n    loginUrl.searchParams.set('from', pathname);\r\n    return NextResponse.redirect(loginUrl);\r\n  }\r\n\r\n  // 3. Super Admin Enforcement\r\n  // Super Admins must stay within /super-admin and bypass other checks\r\n  if (session.role === 'SUPER_ADMIN') {\r\n    if (!pathname.startsWith('/super-admin')) {\r\n      return NextResponse.redirect(new URL('/super-admin', req.url));\r\n    }\r\n    return NextResponse.next();\r\n  }\r\n\r\n  // 4. Portal Protection (Vendors & Market Admins)\r\n  const isApprovedVendor = session.role === 'VENDOR' && session.kycStatus === 'VERIFIED';\r\n  const isApprovedAdmin = session.role === 'MARKET_ADMIN' && session.adminStatus === 'APPROVED';\r\n\r\n  // Vendor Portal Protection\r\n  if (pathname.startsWith('/vendor')) {\r\n    if (!isApprovedVendor) {\r\n      return NextResponse.redirect(new URL('/dashboard', req.url));\r\n    }\r\n  }\r\n\r\n  // Market Admin Portal Protection\r\n  if (pathname.startsWith('/market-admin')) {\r\n    if (!isApprovedAdmin) {\r\n      await logAction(session.id, \"UNAUTHORIZED_ADMIN_ACCESS_ATTEMPT\", { pathname }, ip);\r\n      return NextResponse.redirect(new URL('/dashboard', req.url));\r\n    }\r\n  }\r\n\r\n  // 5. General User Catch-all\r\n  // If a user has no approved role but tries to access role-specific portals\r\n  const restrictedPortals = ['/vendor', '/market-admin', '/super-admin'];\r\n  if (restrictedPortals.some(portal => pathname.startsWith(portal))) {\r\n     return NextResponse.redirect(new URL('/dashboard', req.url));\r\n  }\r\n\r\n  return NextResponse.next();\r\n}\r\n\r\n// Config to specify which paths this proxy should run on\r\nexport const config = {\r\n  matcher: [\r\n    /*\r\n     * Match all request paths except for the ones starting with:\r\n     * - api (API routes)\r\n     * - _next/static (static files)\r\n     * - _next/image (image optimization files)\r\n     * - favicon.ico (favicon file)\r\n     */\r\n    '/((?!api|_next/static|_next/image|favicon.ico).*)',\r\n  ],\r\n};"],"names":[],"mappings":"AAAA,sHAAsH;;;;;;;AAEtH;;;;;;;;AAGA;;;CAGC,GACD,eAAe,UAAU,MAAc,EAAE,MAAc,EAAE,QAAgB,EAAE,EAAU;IACnF,IAAI;QACF,MAAM,MAAM,GAAG,QAAQ,GAAG,CAAC,eAAe,CAAC,eAAe,CAAC,EAAE;YAC3D,QAAQ;YACR,SAAS;gBACP,gBAAgB;gBAChB,qBAAqB,QAAQ,GAAG,CAAC,iBAAiB,IAAI;YACxD;YACA,MAAM,KAAK,SAAS,CAAC;gBACnB;gBACA;gBACA,WAAW,IAAI,OAAO,WAAW;gBACjC,WAAW;gBACX,SAAS;YACX;QACF;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,yBAAyB;IACzC;AACF;AAEe,eAAe,MAAM,GAAgB;IAClD,MAAM,EAAE,QAAQ,EAAE,GAAG,IAAI,OAAO;IAChC,MAAM,KAAK,IAAI,OAAO,CAAC,GAAG,CAAC,sBAAsB;IAEjD,0BAA0B;IAC1B,wCAAwC;IACxC,MAAM,eAAe;QAAC;QAAU;QAAW;QAAK;KAAgB;IAChE,IAAI,aAAa,IAAI,CAAC,CAAA,QAAS,aAAa,UAAU,SAAS,UAAU,CAAC,WAAW;QACnF,OAAO,6PAAY,CAAC,IAAI;IAC1B;IAEA,wBAAwB;IACxB,MAAM,UAAU,MAAM,WAAW;IAEjC,+CAA+C;IAC/C,IAAI,CAAC,SAAS;QACZ,MAAM,WAAW,IAAI,IAAI,UAAU,IAAI,GAAG;QAC1C,SAAS,YAAY,CAAC,GAAG,CAAC,QAAQ;QAClC,OAAO,6PAAY,CAAC,QAAQ,CAAC;IAC/B;IAEA,6BAA6B;IAC7B,qEAAqE;IACrE,IAAI,QAAQ,IAAI,KAAK,eAAe;QAClC,IAAI,CAAC,SAAS,UAAU,CAAC,iBAAiB;YACxC,OAAO,6PAAY,CAAC,QAAQ,CAAC,IAAI,IAAI,gBAAgB,IAAI,GAAG;QAC9D;QACA,OAAO,6PAAY,CAAC,IAAI;IAC1B;IAEA,iDAAiD;IACjD,MAAM,mBAAmB,QAAQ,IAAI,KAAK,YAAY,QAAQ,SAAS,KAAK;IAC5E,MAAM,kBAAkB,QAAQ,IAAI,KAAK,kBAAkB,QAAQ,WAAW,KAAK;IAEnF,2BAA2B;IAC3B,IAAI,SAAS,UAAU,CAAC,YAAY;QAClC,IAAI,CAAC,kBAAkB;YACrB,OAAO,6PAAY,CAAC,QAAQ,CAAC,IAAI,IAAI,cAAc,IAAI,GAAG;QAC5D;IACF;IAEA,iCAAiC;IACjC,IAAI,SAAS,UAAU,CAAC,kBAAkB;QACxC,IAAI,CAAC,iBAAiB;YACpB,MAAM,UAAU,QAAQ,EAAE,EAAE,qCAAqC;gBAAE;YAAS,GAAG;YAC/E,OAAO,6PAAY,CAAC,QAAQ,CAAC,IAAI,IAAI,cAAc,IAAI,GAAG;QAC5D;IACF;IAEA,4BAA4B;IAC5B,2EAA2E;IAC3E,MAAM,oBAAoB;QAAC;QAAW;QAAiB;KAAe;IACtE,IAAI,kBAAkB,IAAI,CAAC,CAAA,SAAU,SAAS,UAAU,CAAC,UAAU;QAChE,OAAO,6PAAY,CAAC,QAAQ,CAAC,IAAI,IAAI,cAAc,IAAI,GAAG;IAC7D;IAEA,OAAO,6PAAY,CAAC,IAAI;AAC1B;AAGO,MAAM,SAAS;IACpB,SAAS;QACP;;;;;;KAMC,GACD;KACD;AACH"}}]
}